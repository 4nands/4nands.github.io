<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<style>
			#canvas_frame{width:500px;height:500px;background-color:yellow;}
		</style>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/109/three.min.js"></script>
		<script src="TrackballControls.js"></script>
		<script>
			var canvas,w,h;
			var scene,renderer,camera,light;
			var trackball;
			var material;
			var x=[];
			var y=[];
			var z=[];
			var vx=[];
			var vy=[];
			var vz=[];
			var v=2;
			var r=5;
			var X=100;
			var Y=100;
			var Z=100;
			var R=30;
			var body=[];
			let n=10;
			let L=200;
			window.addEventListener('load',init);
			function init(){

				canvas=document.getElementById('canvas_frame');
				w=canvas.clientWidth;
				h=canvas.clientHeight;
				
				document.getElementById("n").value = n;
        		document.getElementById("v").value = v;
        		document.getElementById("r").value = r;        
       			document.getElementById("R").value = R;        
				
				

				initState();
			
				loop();
			}
			function initState(){
			
				scene=new THREE.Scene();

				renderer=new THREE.WebGLRenderer({antialias:true});
				renderer.setSize(w,h);
				renderer.setClearColor(0x000000);
				renderer.shadowMap.enabled=true;
				canvas.appendChild(renderer.domElement);

				camera=new THREE.PerspectiveCamera(45,w/h,0.1,1000);
				camera.up.set(0,0,1);
				camera.position.set(300,300,300);
				camera.lookAt(scene.position);

				trackball=new THREE.TrackballControls(camera,canvas);

				var axis=new THREE.AxisHelper(200);
				scene.add(axis);

				light=new THREE.DirectionalLight(0xffffff,1);
				light.position.set(0,0,100);
				light.castShadow=true;
				light.shadow.camera.right=100;
				light.shadow.camera.left=-100;
				light.shadow.camera.top=100;
				light.shadow.camera.bottom=-100;
				scene.add(light);

				material=new THREE.MeshLambertMaterial(0xffffff);
				
				
				coloid = new THREE.Mesh(new THREE.SphereGeometry(R,100,100),material);
				coloid.castShadow=true;
				coloid.receiveShadow=true;
				scene.add(coloid);

				for(let i=0;i<n;i++){
					body[i] = new THREE.Mesh(new THREE.SphereGeometry(r,100,100),material);
					body[i].castShadow=true;
					body[i].receiveShadow=true;
					scene.add(body[i]);
				}
				for(let i=0;i<n;i++){
					x[i]=Math.random()*L;
					y[i]=Math.random()*L;
					z[i]=Math.random()*L;

					a1=Math.random()*Math.PI;
					a2=Math.random()*2*Math.PI;
					
					vx[i]=v*Math.sin(a1)*Math.cos(a2);
					vy[i]=v*Math.sin(a1)*Math.sin(a2);
					vz[i]=v*Math.cos(a1);
					
										
				}
			}

			function loop(){
				for(i=0;i<n;i++){
					x[i] += vx[i];
					y[i] += vy[i];
					z[i] += vz[i];


					if(x[i]<r || x[i]>L-r){
						vx[i]=-vx[i];
					}
					if(y[i]<r || y[i]>L-r){
						vy[i]=-vy[i]
					}
					if(z[i]<r || z[i]>L-r){
						vz[i]=-vz[i]
					}
					d=(X-x[i])*(X-x[i])+(Y-y[i])*(Y-y[i])+(Z-z[i])*(Z-z[i])
		            l=(R+r)*(R+r);

            		if(l>d){
						X+=vx[i]/2;
						Y+=vy[i]/2;
						Z+=vz[i]/2;
						vx[i]=-vx[i];
						vy[i]=-vy[i];
						vz[i]=-vz[i];
						x[i]+=vx[i];
						y[i]+=vy[i];
						z[i]+=vz[i];
					
            		}




					body[i].position.set(x[i],y[i],z[i]);
				
				}
			
				coloid.position.set(X,Y,Z);
				trackball.update();	
				renderer.render(scene,camera);
				
				requestAnimationFrame(loop);
			}
			function clickBtn1(){
				n=document.getElementById("n").value;
				v=document.getElementById("v").value;
				r=parseInt(document.getElementById("r").value);
				R=parseInt(document.getElementById("R").value);
				initState();

   			 }
		</script>
	</head>
	<body>
		
        <Lavel>n=</Lavel>
        <input type="text" id="n" size="1"/>
        <Lavel>v=</Lavel>
        <input type="text" id="v" size="1"/>
        <Lavel>r=</Lavel>
        <input type="text" id="r" size="1"/>
        <Lavel>R=</Lavel>
        <input type="text" id="R" size="1"/>
        <input type="button" value="最初から" onclick="clickBtn1()" />
		<br>
		<div id="canvas_frame"></div>

	</body>
</html>